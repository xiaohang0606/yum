# BettaFish 系统运维指南

## 1. 启动系统

### 1.1 启动主应用

```bash
cd /home/ubuntu/yum

# 后台启动主应用
nohup python app.py > app.log 2>&1 &

# 等待启动完成
sleep 15
```

### 1.2 确认端口

```bash
ss -tlnp | grep -E "5000|8501|8502|8503"
```

**预期输出**（启动系统前只有 5000）：
```
LISTEN 0 50 0.0.0.0:5000 0.0.0.0:* users:(("python",pid=xxx,fd=5))
```

### 1.3 前端启动 Agent

1. 浏览器访问 `http://服务器IP:5000`
2. 点击 **"启动系统"** 按钮
3. 等待 3 个 Streamlit 应用启动

### 1.4 确认所有端口

```bash
ss -tlnp | grep -E "5000|8501|8502|8503"
```

**预期输出**（启动系统后）：
```
LISTEN 0 50 0.0.0.0:5000 0.0.0.0:*
LISTEN 0 50 0.0.0.0:8501 0.0.0.0:*  # Insight Agent
LISTEN 0 50 0.0.0.0:8502 0.0.0.0:*  # Media Agent
LISTEN 0 50 0.0.0.0:8503 0.0.0.0:*  # Query Agent
```

---

## 2. 检查状态

### 2.1 检查进程

```bash
# 检查主应用
ps aux | grep "python app.py" | grep -v grep

# 检查 Streamlit 应用
ps aux | grep streamlit | grep -v grep
```

### 2.2 检查端口

```bash
ss -tlnp | grep -E "5000|8501|8502|8503"
```

### 2.3 查看日志

```bash
# 主应用日志
tail -50 app.log

# Insight Agent 日志
tail -50 logs/insight.log

# Media Agent 日志
tail -50 logs/media.log

# Query Agent 日志
tail -50 logs/query.log

# 实时查看日志（Ctrl+C 退出）
tail -f logs/insight.log
```

### 2.4 检查错误

```bash
# 查看最近的错误
grep -i "error\|exception" logs/insight.log | tail -20
grep -i "error\|exception" logs/media.log | tail -20
grep -i "error\|exception" logs/query.log | tail -20
```

---

## 3. 关闭系统

### 3.1 正常关闭

```bash
# 关闭主应用（会自动关闭子进程）
pkill -f "python app.py"

# 等待进程退出
sleep 3

# 确认已关闭
ps aux | grep -E "app.py|streamlit" | grep -v grep
```

### 3.2 强制关闭

```bash
# 强制杀掉所有相关进程
pkill -9 -f "python app.py"
pkill -9 -f streamlit

# 确认已关闭
ps aux | grep -E "app.py|streamlit" | grep -v grep
```

### 3.3 按端口强制杀死（最彻底）

当上述方法无效时，直接按端口杀死占用进程：

```bash
# 杀死占用 5000 端口的进程
fuser -k 5000/tcp

# 杀死占用 8501/8502/8503 端口的进程
fuser -k 8501/tcp
fuser -k 8502/tcp
fuser -k 8503/tcp

# 或者一行命令杀死所有
for port in 5000 8501 8502 8503; do fuser -k $port/tcp 2>/dev/null; done

# 确认端口已释放
ss -tlnp | grep -E "5000|8501|8502|8503"
```

> **注意**：如果 `fuser` 命令不存在，先安装：`apt install psmisc`

---

## 4. 重启系统

```bash
# 完整重启
pkill -9 -f "python app.py"
pkill -9 -f streamlit
sleep 3
nohup python app.py > app.log 2>&1 &
sleep 15
ss -tlnp | grep -E "5000|8501|8502|8503"
```

然后访问前端点击"启动系统"。

---

## 5. 常见问题排查

### 5.1 502 Bad Gateway

**原因**：浏览器无法访问 8501/8502/8503 端口

**解决**：
1. 检查腾讯云安全组是否开放端口
2. 检查进程是否运行：`ss -tlnp | grep -E "8501|8502|8503"`
3. 重启系统

### 5.2 Agent 卡住不动

**排查**：
```bash
# 查看最新日志
tail -30 logs/insight.log
```

**常见原因**：
- LLM API 超时：检查网络或 API 密钥
- 数据库为空：需要先运行爬虫

### 5.3 LLM API 测试

```bash
python3 -c "
import requests
api_key = 'your-api-key'
url = 'https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions'
headers = {'Authorization': f'Bearer {api_key}', 'Content-Type': 'application/json'}
data = {'model': 'qwen-plus', 'messages': [{'role': 'user', 'content': '你好'}], 'max_tokens': 10}
resp = requests.post(url, headers=headers, json=data, timeout=30)
print(f'状态码: {resp.status_code}')
print(resp.text[:200])
"
```

### 5.4 数据库检查

```bash
python3 -c "
from MindSpider.main import MindSpider
spider = MindSpider()
if spider.initialize_database():
    print('数据库连接成功')
else:
    print('数据库连接失败')
"
```

---

## 6. 端口说明

| 端口 | 服务 | 说明 |
|------|------|------|
| 5000 | Flask 主应用 | 前端入口 |
| 8501 | Insight Agent | 本地数据库分析 |
| 8502 | Media Agent | Bocha API 搜索 |
| 8503 | Query Agent | Tavily 新闻搜索 |

---

## 7. 配置文件说明

| 文件 | 说明 |
|------|------|
| `.env` | 环境变量配置（API 密钥等） |
| `app.log` | 主应用日志 |
| `logs/insight.log` | Insight Agent 日志 |
| `logs/media.log` | Media Agent 日志 |
| `logs/query.log` | Query Agent 日志 |
