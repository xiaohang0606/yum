<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>信镜 TrustLens</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.0/socket.io.js"></script>
    <!-- PDF导出依赖 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <link rel="stylesheet" href="/static/modern-theme.css">

    <!-- PDF中文字体数据 (优化后的子集字体，包含6763个GB2312汉字) -->
    <script src="/static/js/pdf-font-data.js"></script>
</head>
<body>
    <!-- 顶层容器：同时包裹搜索区、双列主工作区与状态栏 -->
    <div class="container">
        <!-- 搜索框区域 -->
        <div class="search-section">
            <h1 class="search-title">信镜 TrustLens - 智能数据分析引擎</h1>
            <div class="search-row">
                <button class="config-button" id="openConfigButton">⚙️ LLM 配置</button>
                <div class="search-box">
                    <input type="text" class="search-input" id="searchInput" placeholder="输入分析需求，全自动分析30+社媒平台与百万评论...">
                    <button class="search-button" id="searchButton">🚀 开始分析</button>
                    <button class="upload-button" id="uploadButton">
                        📄 上传模板
                        <input type="file" id="templateFileInput" accept=".md,.txt" title="上传自定义报告模板(支持 .md 和 .txt 文件)">
                    </button>
                </div>
            </div>
            <div class="upload-status" id="uploadStatus"></div>
        </div>

        <!-- 主内容区域 -->
        <div class="main-content">
            <!-- 嵌入页面区域 -->
            <div class="embedded-section">
                <div class="embedded-header" id="embeddedHeader">📊 实时协作视图</div>
                <div class="embedded-content" id="embeddedContent">
                    <!-- 论坛聊天界面 -->
                    <div class="forum-container" id="forumContainer">
                        <div class="forum-chat-area" id="forumChatArea">
                            <!-- 动态添加的Engine对话消息将在这里显示 -->
                        </div>
                    </div>

                    <!-- 报告引擎界面 -->
                    <div class="report-container" id="reportContainer">
                        <div class="report-content" id="reportContent">
                            <!-- 报告内容将在这里显示 -->
                        </div>
                    </div>

                    <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--text-muted);">
                        <span>💡 点击右侧引擎按钮查看实时输出</span>
                    </div>
                </div>
            </div>

            <!-- 控制台输出区域 -->
            <div class="console-section">
                <!-- 应用切换按钮 -->
                <div class="app-switcher">
                    <button class="app-button active" data-app="insight">
                        <span class="status-indicator" id="status-insight"></span>
                        💾 Insight
                    </button>
                    <button class="app-button" data-app="media">
                        <span class="status-indicator" id="status-media"></span>
                        🎬 Media
                    </button>
                    <button class="app-button" data-app="query">
                        <span class="status-indicator" id="status-query"></span>
                        🔍 Query
                    </button>
                    <button class="app-button" data-app="forum">
                        <span class="status-indicator running" id="status-forum"></span>
                        💬 Forum
                    </button>
                    <button class="app-button locked" data-app="report" title="需等待其余三个Agent工作完毕">
                        <span class="status-indicator" id="status-report"></span>
                        📝 Report
                    </button>
                </div>

                <!-- 控制台状态栏 -->
                <div class="console-status-bar" id="consoleStatusBar">
                    <span class="status-message"></span>
                    <span class="status-details"></span>
                </div>

                <!-- 控制台输出 -->
                <div class="console-output" id="consoleOutput"></div>
            </div>
        </div>

        <!-- 状态栏：实时展示WebSocket连接状态与系统时钟 -->
        <div class="status-bar">
            <div class="status-bar-left">
                <span id="connectionStatus">🔌 连接中...</span>
                <span id="systemTime"></span>
            </div>
            <button class="page-action-button shutdown status-shutdown-button" id="shutdownButton" aria-label="关闭系统">🔴 关闭系统</button>
        </div>
    </div>

    <div class="confirm-overlay" id="shutdownConfirmModal" aria-hidden="true">
        <div class="confirm-dialog danger">
            <div class="confirm-header">
                <div class="confirm-title" id="shutdownStrongText">⚠️ 确定要关闭系统吗？</div>
                <button class="confirm-close" id="closeShutdownConfirm" aria-label="关闭系统确认">×</button>
            </div>
            <div class="confirm-body">
                <div class="confirm-text">
                    <div class="confirm-subtext" id="shutdownSubText">将关闭系统并停止由本控制台启动的子进程，涉及端口/进程：</div>
                    <div class="confirm-list" id="shutdownRunningList"></div>
                    <div class="confirm-list" id="shutdownPortList"></div>
                </div>
            </div>
            <div class="confirm-actions">
                <button class="confirm-button" id="cancelShutdownButton">取消</button>
                <button class="confirm-button danger" id="confirmShutdownButton">立即关闭系统</button>
            </div>
        </div>
    </div>

    <!-- 配置弹窗：与后端.env互通，允许在线修改LLM参数 -->
    <div class="config-modal-overlay" id="configModal">
        <div class="config-modal">
            <div class="config-modal-header">
                <div class="config-modal-title">⚙️ LLM 配置 - 与.env文件双向同步</div>
                <div class="config-modal-actions">
                    <button class="config-secondary-button" id="refreshConfigButton">🔄 刷新</button>
                    <button class="config-close-button" id="closeConfigModal" aria-label="关闭配置窗口">×</button>
                </div>
            </div>
            <div class="config-modal-body" id="configFormContainer">
                <!-- 由脚本填充 -->
            </div>
            <div class="config-modal-footer">
                <div class="config-status-message" id="configStatusMessage"></div>
                <div class="config-modal-footer-actions">
                    <button class="config-save-button" id="saveConfigButton">💾 保存</button>
                    <button class="config-start-button" id="startSystemButton">🚀 保存并启动系统</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 消息提示：右上角滑出式成功/错误提醒 -->
    <div class="message" id="message"></div>

    <!-- 前端业务脚本：维护Socket连接、引擎启动状态与Report Engine交互 -->
    <script src="/static/js/main.js"></script>
</body>
</html>
